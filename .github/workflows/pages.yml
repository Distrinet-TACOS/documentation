name: Render & deploy quarto webpage to Pages

on:
  push:
    branches: [$default-branch]

concurrency:
  group: "pages"
  cancel-in-progress: true

inputs:
  name:
    description: 'Artifact name'
    required: false
    default: 'github-pages'
  path:
    description: "Path of the directory containing the static assets."
    required: true
    default: "public/"
  retention-days:
    description: "Duration after which artifact will expire in days."
    required: false
    default: "1"
  quarto-version:
    description: "Version of Quarto to use for rendering."
    required: false
    default: "1.1.251"

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  render:
    name: Render
    runs-on: ubuntu-latest
    container: python
    steps:
      - uses: actions/checkout@v3
      - name: Download and install Quarto
        run: |
          wget "https://github.com/quarto-dev/quarto-cli/releases/download/v${{ inputs.quarto-version }}/quarto-${QUARTO_VERSION}-linux-amd64.deb"
          dpkg -i quarto-${{ inputs.quarto-version }}-linux-amd64.deb
          quarto check install
          quarto install tool tinytex
      - name: Render
        run: quarto render
      - name: Upload artifact
        uses: actions/upload-artifact@main
        with:
          name: ${{ inputs.name }}
          path: ${{ inputs.path }}
          retention-days: ${{ inputs.retention-days }}

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: render
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Setup Pages
        uses: actions/configure-pages@v3
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v1